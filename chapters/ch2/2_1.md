# 2. 架构
本节描述了libvirt API和libvirt模块定义背后的主要原则和架构。
  
## 2.1. 对象模型
libvirt API和Python的libvirt模块试图去扩展部署和管理虚拟机需要的所有的方法。对hypervisor功能和结点资源的管理对于一个虚拟机来说是必须的,比如网络、存储和PCI/USB设备。libvirt暴露的大部分类和方法有一个可插拔的内部后端, 这样就可以支持不同的底层虚拟化技术和操作系统。因此,一个特定的API或者方法的功能扩展是由使用的特定的hypervisor驱动和底层虚拟化技术提供的能力决定的。  

### 2.1.1 Hypervisor连接
连接是在libvirt API和libvirt模块中的主要或者顶层的对象。几乎在使用任何类或者方法的前都需要一个连接对象的实例。一个连接和一个特定的hypervisor关联,libvirt应用程序可以和hypervisor可以在一台机器上,也可以在不同的机器上。在所有情况下,连接通过**virConnect**类的实例来表示,并通过连接URI来识别。URI的组合和路径定义了待连接的hypervisor,URI的host部分标识了hypervisor在哪。参考[3.2节,"URI格式"](content/ch3/3_2.md)对一个有效的URI的完全描述。  

应用程序允许同时打开多个连接,即使连接的是同一个hypervisor。比如,一个主机可能既提供KVM完全虚拟化,也提供LXC容器虚拟化。一个连接对象可能在多线程中并发使用。一旦一个连接建立了,它就有可能获取其他被管理对象的handle或者创建新的被管理对象,会在[2.1.2 域](2_1_2.md)中讨论  

### 2.1.2. 域
域可以是一个运行的虚拟机或者一个可以用于启动虚拟机的配置。连接对象提供了枚举域、创建新域和管理已存在域的方法。域通过virDomain类的实例来表示并有一个唯一的标识符。  

**唯一标识符**    

- **ID**: 正整数,在一个主机上,运行的域的ID是唯一的。一个处于inactive状态的域没有ID。  
- **name**: 短字符串,在一个主机上,所有运行和inactive的域都有name,并且唯一。为了最大限度的保证不同hypervisor上的兼容性,name命名只包含字符、数字、减号和下划线。  
- **UUID**: 16个无符号字节,在所有主机上都是唯一的。RFC 4122定义了UUID的格式并推荐了一个生成唯一UUID的方法。  

一个域可以是临时的也可以是持久化的。一个临时的域只能在它运行的时候被管理,一旦断电它就会消失。一个持久化的域的配置信息被hypervisor管理并存储在主机上。因此,当一个持久化的域断电后,还是可以管理它的inactive配置。一个临时的域可以通过给它定义一个配置将其转换为持久化的域。  

参考[第4节,域]()获得更多关于域的信息。

### 2.1.3. 虚拟网络
虚拟网络为一个主机上的多个域之间实现网络设备互联提供了方法。虚拟网络可以是:  

- 和主机的网络隔离,或者  
- 允许使用主机的网络接口设备和外界通信。包括使用NAT。  

一个虚拟网络通过virNetwork类的实例来表示,有两个唯一标识符:  

- **name**: 短字符串,在一个主机上的所有虚拟网络上是唯一的,包括active和inactive状态的。为了最大限度的保证不同hypervisor上的兼容性,name命名只包含字符、数字、减号和下划线。  
- **UUID**: 16个无符号字节,在所有主机上都是唯一的。RFC 4122定义了UUID的格式并推荐了一个生成唯一UUID的方法。  

一个虚拟网络可以是临时的也可以是持久化的。一个临时的虚拟网络只能在运行状态下被管理,掉线后它就会消失。一个持久化的虚拟网络的配置信息被hypervisor管理并存储在主机上。因此，当一个持久化的虚拟网络掉线后，还是可以管理它的inactive配置。一个临时的网络可以通过给它定义一个配置将其转换为持久化的网络。  

在安装完libvirt后，每一个主机上都会有一个被称为default的虚拟网络，这个虚拟网络向客户机提供DHCP服务并且允许NAT连接到主机的网络接口上。这在间歇性网络访问的场景下很有用。比如，笔记本使用无线网络连接。  

参考[第6节，虚拟网络]()获得更多关于虚拟网络对象使用的信息。

### 2.1.4. 存储池
存储池提供了管理主机上所有类型存储的机制，比如本地磁盘、逻辑卷组、iSCSI target、FiberChannel HBA和本地或网络文件系统。一个池包含多个独立的卷。一个池通过**virStoragePool**类的实例来表示并有一对标识符：  

**唯一标识符**    

- **name**: 短字符串,在一个主机上的所有存储池是唯一的,包括active和inactive状态的。为了最大限度的保证不同hypervisor上的兼容性,name命名只包含字符、数字、减号和下划线。  
- **UUID**: 16个无符号字节,在所有主机上都是唯一的。RFC 4122定义了UUID的格式并推荐了一个生成唯一UUID的方法。   

一个存储池可以是临时的也可以是持久化的。一个临时的存储池只能在运行状态下被管理,断电后它就会消失（但是底层的物理存储还会存在）。一个持久化的存储池的配置信息被hypervisor管理并存储在主机上。因此，当一个持久化的存储池在断电后，还是可以管理它的inactive配置。一个临时的存储池可以通过给它定义一个配置将其转换为持久化的存储池。   

参考[第5节，存储池]()获得更多关于虚拟网络对象使用的信息。 

### 2.1.5. 存储卷
存储卷对象提供从存储池里面分配的块设备的管理，可以是磁盘分区、逻辑卷、iscsi target或者是本地或者网络文件系统中的一个文件。一旦分配，卷可以给一个或者多个域提供磁盘。一个卷通过**virStorage**类的实例来表示并有三个标识符：

**唯一标识符**    

- **name**: 短字符串,在一个存储池中的所有存储卷是唯一的。为了最大限度的保证不同hypervisor上的兼容性,name命名只包含字符、数字、减号和下划线。在重启后或者不同主机之间，不保证名字是不变的，即使存储池在多个主机之间共享。    
- **Key**: 为了在一个存储池中唯一标识一个卷。key在重启或者不同主机之间应该是稳定的。
- **Path**: 指向这个卷的文件系统路径。在一个主机上所有存储卷的路径是唯一的。如果一个   

### 2.1.6. 主机设备
主机设备为主机上可用设备提供了一个视图。既包括了物理的USB或者PCI设备，也包括了逻辑设备，比如NIC、磁盘、磁盘控制器和声卡等。设备可以被整理为树的形式，方便理清设备间的关系。主机设备通过virNodeDev类的实例来表示并且有一个通用标识符，尽管特定类型的设备可能有它们自己的惟一标识符。
name：短字符串，在主机的所有设备上是唯一的，命名方案是由主机操作系统决定的。在重启后不保证设备名不变。  




物理设备可以从主机驱动中分离，这会隐式地移除关联的逻辑设备。并重新分配给域。当使用网络和存储的API来确定哪些资源可以配置时，物理设备信息是很有用的。


驱动模型
libvirt确保对外暴露了稳定的API和ABI，和任何特定的虚拟化技术解耦合。另外，很多API关联了XML模式，来确保ABI是稳定的。在libvirt内部，对外暴露的ABI有很多种具体实现，每一种实现都针对一种具体的虚拟化技术，每一种实现称为驱动。







